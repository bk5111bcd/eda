name: Code Quality & Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11']

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pylint flake8
    
    - name: Lint with Flake8
      run: |
        flake8 auto_eda_chatbot/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 auto_eda_chatbot/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Check import structure
      run: |
        python -c "import auto_eda_chatbot.app as app; print('âœ“ App imports successfully')"
        python -c "import auto_eda_chatbot.auth as auth; print('âœ“ Auth imports successfully')"
        python -c "import auto_eda_chatbot.pdf_generator as pdf; print('âœ“ PDF generator imports successfully')"
    
    - name: Verify dependencies
      run: |
        python -c "
        required = ['streamlit', 'pandas', 'numpy', 'matplotlib', 'seaborn', 'plotly', 'fpdf2']
        import importlib
        for pkg in required:
            try:
                importlib.import_module(pkg)
                print(f'âœ“ {pkg} available')
            except ImportError:
                print(f'âœ— {pkg} missing')
        "

  security:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install security tools
      run: |
        pip install bandit safety
    
    - name: Run Bandit security scan
      run: |
        bandit -r auto_eda_chatbot/ -f json -o bandit-report.json || true
    
    - name: Check dependencies for vulnerabilities
      run: |
        safety check --json || true

  documentation:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Check README exists
      run: |
        if [ -f README.md ]; then echo "âœ“ README.md found"; else echo "âœ— README.md missing" && exit 1; fi
    
    - name: Check requirements.txt exists
      run: |
        if [ -f requirements.txt ]; then echo "âœ“ requirements.txt found"; else echo "âœ— requirements.txt missing" && exit 1; fi
    
    - name: Check LICENSE exists
      run: |
        if [ -f LICENSE ]; then echo "âœ“ LICENSE found"; else echo "âœ— LICENSE missing" && exit 1; fi
    
    - name: Verify documentation
      run: |
        echo "ðŸ“š Documentation files:"
        ls -la *.md || echo "No markdown files found"
